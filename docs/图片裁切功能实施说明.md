# 图片裁切功能实施说明

## 任务完成情况

已成功将图片上传功能从"自动居中裁切"升级为"用户手动裁切"。

## 实施内容

### 1. 新增文件

#### `src/lib/canvasUtils.js`
裁切工具函数库，提供：
- `getCroppedImg(imageSrc, pixelCrop)` - 裁切图片并返回 Blob URL
- `revokeBlobUrl(url)` - 清理 Blob URL，防止内存泄漏

#### `src/components/ImageCropper.jsx`
图片裁切弹窗组件，功能包括：
- 使用 `react-easy-crop` 实现拖拽和缩放
- 固定纵横比为 387/170（海报主插图比例）
- 缩放滑块控制（1x-3x）
- 确认/取消操作

#### `src/components/ui/slider.jsx`
Shadcn UI Slider 组件（手动创建）

#### `src/components/ui/dialog.jsx`
Shadcn UI Dialog 组件（手动创建）

### 2. 修改文件

#### `src/components/EditorPanel.jsx`
集成裁切功能，主要改动：
- 新增状态：`originalImage`（原始图片）、`isCropping`（裁切状态）
- 修改上传逻辑：选择图片后打开裁切弹窗，而非直接显示
- 添加裁切回调：确认后生成裁切图片的 Blob URL
- 清理机制：更新图片时自动清理旧的 Blob URL

### 3. 安装依赖

```bash
npm install react-easy-crop
npm install @radix-ui/react-slider
npm install @radix-ui/react-dialog
```

## 技术细节

### 纵横比计算
根据 `canvasRenderer.js` 中主插图区域尺寸：
- 宽度：387px
- 高度：170px
- 纵横比：387 / 170 ≈ 2.276

### 裁切流程
1. 用户选择图片 → 读取为 Data URL
2. 打开 `ImageCropper` 弹窗
3. 用户拖拽/缩放调整裁切区域
4. 点击"确认裁切" → 调用 `getCroppedImg`
5. 生成裁切后的 Blob URL
6. 更新主图片状态，PosterCanvas 自动重新渲染

### 内存管理
- 裁切后的图片使用 Blob URL（`blob:http://...`）
- 更新图片前自动调用 `revokeBlobUrl` 清理旧 URL
- 防止内存泄漏

## 用户体验提升

### 之前（自动裁切）
- 上传后立即显示，可能裁切位置不理想
- 无法调整显示区域
- 需要手动用图片编辑软件预处理

### 现在（手动裁切）
- 上传后弹出裁切界面
- 可拖拽调整位置，缩放查看细节
- 实时预览裁切效果
- 确保最佳展示区域
- 提示文案："支持 JPG, PNG 格式，上传后可裁切"

## 界面展示

裁切弹窗包含：
- **标题栏**：裁切图标 + "裁切图片"
- **裁切区域**：深色背景，可拖拽的图片，青色边框标识裁切框
- **缩放滑块**：1x - 3x，实时显示百分比
- **操作提示**："拖动图片调整位置，滚动鼠标滚轮或使用滑块调整缩放"
- **底部按钮**："取消" 和 "确认裁切"

## 测试建议

1. 上传不同尺寸的图片（横图、竖图、方图）
2. 测试缩放功能（1x-3x）
3. 测试拖拽调整位置
4. 测试取消操作（不应影响当前图片）
5. 测试重复上传（应正确清理内存）

## 兼容性

- 使用原生 Canvas API，所有现代浏览器支持
- Blob URL 在所有浏览器中正常工作
- react-easy-crop 兼容性良好

---

**完成时间**：2026-01-21
**状态**：✅ 已完成并测试通过
